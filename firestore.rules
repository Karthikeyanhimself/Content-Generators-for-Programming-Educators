/**
 * @fileOverview Firestore Security Rules for AlgoGenius platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data,
 * and public read access for system-generated scenarios. Write access is
 * carefully controlled to ensure data integrity and prevent unauthorized
 * modifications. Authorization is primarily achieved through path-based
 * ownership.
 *
 * Data Structure:
 * - /users/{userId}: Stores user account information and profile data. Document ID is the userId.
 * - /roster/{studentId}: A global list of all students on the platform.
 * - /scenarios/{scenarioId}: Stores system-generated programming scenarios, publicly readable.
 * - /users/{userId}/assignments/{assignmentId}: Stores assignments assigned to a user.
 * - /educators/{educatorId}/submissions/{submissionId}: Denormalized submissions for easy querying.
 * - /scenarios/{scenarioId}/hints/{hintId}: Stores hints related to a specific scenario.
 * - /scenarios/{scenarioId}/testCases/{testCaseId}: Stores test cases for a specific scenario.
 *
 * Key Security Decisions:
 * - Users can only read/write their own user and profile data.
 * - The global roster is only readable by authenticated educators.
 * - Students can only create their own entry in the roster upon signup.
 * - Scenarios are publicly readable, but write access is restricted.
 * - Assignments are owned by the user they are assigned to.
 * - Listing all users is allowed for educators to perform the one-time roster fix.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isEducator() {
      // Check if the requesting user has the 'educator' role in their user profile document.
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'educator';
    }

    /**
     * @description Controls access to user account documents.
     * - A user can always read/write their own document.
     */
    match /users/{userId} {
      allow get, read: if isOwner(userId);
      allow write: if isOwner(userId);
      // Allow educators to list users for the one-time roster fix.
      allow list: if isEducator();
    }
    
    /**
     * @description Global roster of all students.
     * - Educators can read the full roster to assign work.
     * - Students can only create their own roster entry upon signup.
     */
    match /roster/{studentId} {
      allow list, get: if isEducator();
      allow create: if isOwner(studentId); // A user can create their own roster entry.
      allow update, delete: if false;
    }

    /**
     * @description Controls access to scenario documents. Scenarios are publicly readable, but write access is restricted.
     */
    match /scenarios/{scenarioId} {
      allow get, list: if true;
      allow create: if request.auth != null; // Allow authenticated users (educators or SYSTEM) to create
      allow update, delete: if false;
    }

    /**
     * @description Controls access to assignment documents.
     */
    match /users/{userId}/assignments/{assignmentId} {
      // READ: A user can only read their own assignments.
      allow get, list: if isOwner(userId);
      
      // CREATE:
      // 1. A user can create their own assignment (educator drafting).
      // 2. An educator can create an assignment for a student.
      allow create: if isOwner(userId) || isEducator();
      
      // UPDATE:
      // A student can update their own assignment (e.g., to submit it).
      // An educator can update a student's assignment (e.g., to publish a score).
      allow update: if isOwner(userId) || isEducator();

      // DELETE: Only the owner can delete their assignments.
      allow delete: if isOwner(userId);
    }

    /**
     * @description Denormalized submissions for easy educator querying.
     * - An educator can read/list their own submissions.
     * - A student can create a submission record only if the educatorId matches the one on their original assignment.
     * - An educator can update a submission record (e.g. to mark as published).
     */
    match /educators/{educatorId}/submissions/{submissionId} {
      allow read, list: if isOwner(educatorId);

      function isStudentTheSubmitter() {
        return request.auth != null && request.resource.data.studentId == request.auth.uid;
      }

      function doesOriginalAssignmentBelongToEducator(educatorId) {
        let originalAssignmentPath = /databases/$(database)/documents/users/$(request.auth.uid)/assignments/$(request.resource.data.originalAssignmentId);
        return get(originalAssignmentPath).data.educatorId == educatorId;
      }

      allow create: if isStudentTheSubmitter() && doesOriginalAssignmentBelongToEducator(educatorId);
      allow update: if isOwner(educatorId); // Educator can update (e.g., to publish)
      allow delete: if false;
    }


    /**
     * @description Controls access to hint documents. Hints are readable, but write access is denied.
     */
    match /scenarios/{scenarioId}/hints/{hintId} {
      allow get, list: if true;
      allow create: if request.auth != null; // Allow scenario creator to add hints.
      allow update, delete: if false;
    }

    /**
     * @description Controls access to test case documents. Test cases are readable, but write access is denied.
     */
    match /scenarios/{scenarioId}/testCases/{testCaseId} {
      allow get, list: if true;
      allow create: if request.auth != null; // Allow scenario creator to add test cases.
      allow update, delete: if false;
    }
  }
}
