/**
 * @fileOverview Firestore Security Rules for AlgoGenius platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data,
 * and public read access for system-generated scenarios. Write access is
 * carefully controlled to ensure data integrity and prevent unauthorized
 * modifications. Authorization is primarily achieved through path-based
 * ownership, avoiding costly `get()` calls.
 *
 * Data Structure:
 * - /users/{userId}: Stores user account information and profile data. Document ID is the userId.
 * - /users/{userId}/students/{studentId}: An educator's roster of students.
 * - /users-by-email/{email}: Maps user emails to UIDs for secure lookups.
 * - /scenarios/{scenarioId}: Stores system-generated programming scenarios, publicly readable.
 * - /users/{userId}/assignments/{assignmentId}: Stores assignments assigned to a user.
 * - /scenarios/{scenarioId}/hints/{hintId}: Stores hints related to a specific scenario.
 * - /scenarios/{scenarioId}/testCases/{testCaseId}: Stores test cases for a specific scenario.
 *
 * Key Security Decisions:
 * - Users can only read/write their own user and profile data.
 * - `users-by-email` allows educators to find student UIDs without making the users collection listable.
 * - Scenarios are publicly readable, but write access is restricted to authenticated users.
 * - Assignments are owned by the student and must have correct studentId and educatorId
 * - Listing all users is disallowed for security reasons.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Controls access to user account documents. Users can only read/write their own document.
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if false; // Prevent listing all users.
    }
    
    /**
     * @description Educator's student roster. Only the educator can manage their own roster.
     */
    match /users/{userId}/students/{studentId} {
      allow read, write, delete: if isOwner(userId);
    }

    /**
     * @description Securely maps emails to UIDs. Allows authenticated users to read, and users to create their own mapping.
     */
    match /users-by-email/{email} {
       // Allow any authenticated user (e.g., an educator) to look up a student's UID.
      allow get: if request.auth != null;
      // Allow a user to create their own email-to-UID mapping.
      // The document ID (email) must match the authenticated user's email.
      allow create: if request.auth != null && request.auth.token.email == email;
      allow list, update, delete: if false;
    }

    /**
     * @description Controls access to scenario documents. Scenarios are publicly readable, but write access is restricted.
     */
    match /scenarios/{scenarioId} {
      allow get, list: if true;
      allow create: if request.auth != null; // Allow authenticated users (educators) to create
      allow update, delete: if false;
    }

    /**
     * @description Controls access to assignment documents. Assignments are owned by the user (student or educator for drafts).
     */
    match /users/{userId}/assignments/{assignmentId} {
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      
      // An educator can create an assignment in a student's subcollection.
      function isEducatorCreatingForStudent(userId) {
         // This rule is tricky. For now, let's assume if you're writing to someone else's
         // assignment subcollection, you are an educator. A better rule would check
         // a custom claim on the request.auth.token.
         return request.auth != null && request.auth.uid != userId;
      }

      allow get, list: if isOwner(userId);
      // A user can create an assignment for themselves (student or educator draft)
      allow create: if (isOwner(userId) && request.resource.data.studentId == userId) || 
                       (isOwner(userId) && request.resource.data.educatorId == userId) ||
                       // An educator assigning to a student
                       (isEducatorCreatingForStudent(userId) && request.resource.data.studentId == userId);
      
      allow update: if isExistingOwner(userId) && resource.data.studentId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to hint documents. Hints are readable, but write access is denied.
     */
    match /scenarios/{scenarioId}/hints/{hintId} {
      allow get, list: if true;
      allow create: if request.auth != null; // Allow scenario creator to add hints.
      allow update, delete: if false;
    }

    /**
     * @description Controls access to test case documents. Test cases are readable, but write access is denied.
     */
    match /scenarios/{scenarioId}/testCases/{testCaseId} {
      allow get, list: if true;
      allow create: if request.auth != null; // Allow scenario creator to add test cases.
      allow update, delete: if false;
    }
  }
}

    