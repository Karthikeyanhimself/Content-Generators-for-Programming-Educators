/**
 * @fileOverview Firestore Security Rules for AlgoGenius platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data,
 * and public read access for system-generated scenarios. Write access is
 * carefully controlled to ensure data integrity and prevent unauthorized
 * modifications. Authorization is primarily achieved through path-based
 * ownership, avoiding costly `get()` calls where possible, but allowing them
 * for specific, secure cross-user lookups (like an educator reading a student's profile).
 *
 * Data Structure:
 * - /users/{userId}: Stores user account information and profile data. Document ID is the userId.
 * - /users/{userId}/students/{studentId}: An educator's roster of students. The studentId is the student's UID.
 * - /users-by-email/{email}: Maps user emails to UIDs for secure lookups.
 * - /scenarios/{scenarioId}: Stores system-generated programming scenarios, publicly readable.
 * - /users/{userId}/assignments/{assignmentId}: Stores assignments assigned to a user.
 * - /educators/{educatorId}/submissions/{submissionId}: Denormalized submissions for easy querying.
 * - /scenarios/{scenarioId}/hints/{hintId}: Stores hints related to a specific scenario.
 * - /scenarios/{scenarioId}/testCases/{testCaseId}: Stores test cases for a specific scenario.
 *
 * Key Security Decisions:
 * - Users can only read/write their own user and profile data.
 * - **Exception**: An educator can read a student's profile if that user's role is 'student'.
 * - `users-by-email` allows any authenticated user to find a student's UID by email.
 * - Scenarios are publicly readable, but write access is restricted.
 * - Assignments are owned by the student, but can be created by an educator.
 * - Listing all users is disallowed for security reasons.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Checks if the requesting user is an educator.
    function isEducator() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'educator';
    }

    // Checks if the target user is a student.
    function isTargetStudent(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data.role == 'student';
    }

    /**
     * @description Controls access to user account documents.
     * - A user can always read/write their own document.
     * - An educator can read a student's document.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || (isEducator() && isTargetStudent(userId));
      allow write: if isOwner(userId);
      allow list: if false; // Prevent listing all users.

      /**
       * @description Educator's student roster. Only the educator can manage their own roster.
       */
      match /students/{studentId} {
        allow read, list, write, delete: if isOwner(userId);
      }
      
      /**
       * @description Controls access to assignment documents. A user can fully manage their own assignments.
       */
      match /assignments/{assignmentId} {
        // Read permission grants both 'get' and 'list'.
        allow read: if isOwner(userId);
        // Allow user to update/delete their own assignment
        allow write: if isOwner(userId);
        // Allow educator to create assignment for student
        allow create: if isEducator() && request.resource.data.educatorId == request.auth.uid;
      }
    }
    
    match /users/{userId}/assignments {
        allow list: if isOwner(userId);
    }
    
    /**
     * @description Securely maps emails to UIDs. Allows any authenticated user to read,
     * and users to create their own mapping. This is the crucial lookup step for an educator.
     */
    match /users-by-email/{email} {
      allow get: if request.auth != null;
      // Allow a user to create their own email-to-UID mapping.
      // The document ID (email) must match the authenticated user's email.
      allow create: if request.auth != null && request.auth.token.email == email;
      allow list, update, delete: if false;
    }

    /**
     * @description Controls access to scenario documents. Scenarios are publicly readable, but write access is restricted.
     */
    match /scenarios/{scenarioId} {
      allow get, list: if true;
      allow create: if isEducator(); // Allow authenticated educators to create
      allow update, delete: if false;

      /**
       * @description Controls access to hint documents. Hints are readable, but write access is denied.
       */
      match /hints/{hintId} {
        allow get, list: if true;
        allow create: if isEducator();
        allow update, delete: if false;
      }

      /**
       * @description Controls access to test case documents. Test cases are readable, but write access is denied.
       */
      match /testCases/{testCaseId} {
        allow get, list: if true;
        allow create: if isEducator();
        allow update, delete: if false;
      }
    }

    /**
     * @description Denormalized submissions for easy educator querying.
     * - Educators can read/update/list their own submissions collection.
     * - Students can create submissions in the correct educator's collection.
     */
    match /educators/{educatorId}/submissions/{submissionId} {
      function isStudentTheSubmitter() {
        return request.auth != null && request.resource.data.studentId == request.auth.uid;
      }

      function doesOriginalAssignmentBelongToEducator(educatorId) {
        let originalAssignmentPath = /databases/$(database)/documents/users/$(request.auth.uid)/assignments/$(request.resource.data.originalAssignmentId);
        let assignmentDoc = get(originalAssignmentPath);
        return assignmentDoc.data.educatorId == educatorId;
      }

      allow read, update: if request.auth != null && request.auth.uid == educatorId;
      allow create: if isStudentTheSubmitter() && doesOriginalAssignmentBelongToEducator(educatorId);
      allow delete: if false;
    }
    
    // Rule for LISTING submissions
    match /educators/{educatorId}/submissions {
        allow list: if request.auth != null && request.auth.uid == educatorId;
    }
  }
}
